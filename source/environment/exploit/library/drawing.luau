local Roblox: table = require("@lune/roblox")
local Manager: table = require("@env/manager")
local Drawing: table = Manager.create()
local Helpers: table = Manager.create()
local Fonts: table = Drawing:namespace("Fonts", {
  UI = 0,
  System = 1,
  Plex = 2,
  Monospace = 3
})

local SupportedTypes: table = {
  Line = true,
  Text = true,
  Image = true,
  Circle = true,
  Square = true,
  Quad = true,
  Triangle = true
}

local PropertySchema: table = {
  Base = {
    Visible = "boolean",
    ZIndex = "number",
    Transparency = "number",
    Color = "Color3"
  },
  Line = {
    From = "Vector2",
    To = "Vector2",
    Thickness = "number"
  },
  Text = {
    Text = "string",
    Font = "number",
    Size = "number",
    Position = "Vector2",
    Center = "boolean",
    Outline = "boolean",
    OutlineColor = "Color3",
    TextBounds = "readonly"
  },
  Image = {
    Data = "string",
    Size = "Vector2",
    Position = "Vector2",
    Rounding = "number",
    Visible = "boolean"
  },
  Circle = {
    NumSides = "number",
    Radius = "number",
    Position = "Vector2",
    Thickness = "number",
    Filled = "boolean"
  },
  Square = {
    Size = "Vector2",
    Position = "Vector2",
    Thickness = "number",
    Filled = "boolean"
  },
  Quad = {
    PointA = "Vector2",
    PointB = "Vector2",
    PointC = "Vector2",
    PointD = "Vector2",
    Thickness = "number",
    Filled = "boolean"
  },
  Triangle = {
    PointA = "Vector2",
    PointB = "Vector2",
    PointC = "Vector2",
    Thickness = "number",
    Filled = "boolean"
  }
}

local DrawingObjects: table = {}

local Vector2 = Roblox.Vector2
local Color3 = Roblox.Color3

local function isDrawingObject(Object: Drawing): boolean
  return DrawingObjects[Object] == Object
end

Helpers:define("isrenderobj", function(Object: Drawing): boolean
  if type(Object) ~= "userdata" then
    return false
  end
  
  return isDrawingObject(Object)
end)

Helpers:define("getrenderproperty", function(Object: Drawing, Property: string): any?
  Helpers:checktype(1, Object, "userdata")
  Helpers:checktype(2, Property, "string")
  assert(isDrawingObject(Object), "invalid argument #1 to 'getrenderproperty' (expected valid drawing got, invalid drawing)")
  
  return Object[Property]
end)

Helpers:define("setrenderproperty", function(Object: Drawing, Property: string, Value: any?): nil
  Helpers:checktype(1, Object, "userdata")
  Helpers:checktype(2, Property, "string")
  Helpers:checktype(3, Property, "any")
  assert(isDrawingObject(Object), "invalid argument #1 to 'setrenderproperty' (expected valid drawing got, invalid drawing)")
  
  Object[Property] = Value
end)

Helpers:define("cleardrawcache", function(): nil
  DrawingObjects = {}
end)

local function Clamp(n: number, min: number, max: number): number
  if n < min then return min end
  if n > max then return max end
  return n
end

local function CheckType(Value: any, Expected: string): (boolean, string?)
  if Expected == "readonly" then
    return false, "property is read-only"
  end

  if Expected == "Vector2" then
    return typeof(Value) == "Vector2"
  end

  if Expected == "Color3" then
    return typeof(Value) == "Color3"
  end

  return type(Value) == Expected
end

Drawing:define("new", function(Type: string): Drawing
  Drawing:checktype(1, Type, "string")
  assert(SupportedTypes[Type], "invalid argument #1 to 'Drawing.new' (supported type expected, got " .. Type .. ")")

  local Properties: table = {
    Visible = false,
    ZIndex = 1,
    Transparency = 1,
    Color = Color3.new(0, 0, 0),
    __OBJECT_EXISTS = true
  }

  function Properties:Destroy()
    assert(self, "invalid argument #1 to 'Drawing:Destroy' (expected self but got nil)")
    Properties.__OBJECT_EXISTS = false
    Properties.Visible = false
  end

  if Type == "Line" then
    Properties.From = Vector2.new(0, 0)
    Properties.To = Vector2.new(0, 0)
    Properties.Thickness = 0
  end

  if Type == "Text" then
    Properties.Text = ""
    Properties.TextBounds = 0
    Properties.Font = 3
    Properties.Size = 0
    Properties.Position = Vector2.new(0, 0)
    Properties.Center = false
    Properties.Outline = false
    Properties.OutlineColor = Color3.new(0, 0, 0)
  end

  if Type == "Image" then
    Properties.Data = ""
    Properties.Size = Vector2.new(50, 50)
    Properties.Position = Vector2.new(0, 0)
    Properties.Rounding = 0
    Properties.Visible = true
  end

  if Type == "Circle" then
    Properties.NumSides = 0
    Properties.Radius = 1
    Properties.Position = Vector2.new(0, 0)
    Properties.Thickness = 1
    Properties.Filled = false
  end

  if Type == "Square" then
    Properties.Size = Vector2.new(0, 0)
    Properties.Position = Vector2.new(0, 0)
    Properties.Thickness = 0
    Properties.Filled = false
  end

  if Type == "Quad" then
    Properties.PointA = Vector2.new(0, 0)
    Properties.PointB = Vector2.new(0, 0)
    Properties.PointC = Vector2.new(0, 0)
    Properties.PointD = Vector2.new(0, 0)
    Properties.Thickness = 0
    Properties.Filled = false
  end

  if Type == "Triangle" then
    Properties.PointA = Vector2.new(0, 0)
    Properties.PointB = Vector2.new(0, 0)
    Properties.PointC = Vector2.new(0, 0)
    Properties.Thickness = 0
    Properties.Filled = false
  end

  local Schema = {}
  
  for k, v in pairs(PropertySchema.Base) do
    Schema[k] = v
  end
  
  if PropertySchema[Type] then
    for k, v in pairs(PropertySchema[Type]) do
      Schema[k] = v
    end
  end
  
  local Proxy = newproxy(true)
  local MT = getmetatable(Proxy)

  MT.__index = function(_, Key)
    if Type == "Text" and Properties.TextBounds == 0 and Key == "TextBounds" then
      local Width = #Properties.Text * Properties.Size * 0.5
      return Vector2.new(Width, Properties.Size)
    end
    
    return Properties[Key]
  end

  MT.__newindex = function(_, Key, Value)
    assert(Properties.__OBJECT_EXISTS, Type .. ": object is destroyed cannot edit properties!", 2)
    
    local Expected = Schema[Key]
    if not Expected then
      error(Type .. ": cannot add new property '" .. tostring(Key) .. "'", 2)
    end
    
    local Ok, Reason = CheckType(Value, Expected)
    if not Ok then
      error(
        string.format(
          "%s: invalid value for '%s' (%s expected, got %s)",
          Type,
          Key,
          Expected,
          typeof(Value)
        ),
        2
      )
    end
    
    if Key == "Transparency" then
      Value = Clamp(Value, 0, 1)
    end
    
    rawset(Properties, Key, Value)
  end

  MT.__tostring = function()
    return "Drawing"
  end

  MT.__metatable = "Locked"

  DrawingObjects[Proxy] = Proxy

  return Proxy
end)

return { Main = Drawing:export(), Helpers = Helpers:export() }