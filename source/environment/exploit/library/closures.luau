local Process: table = require("@lune/process")
local Manager: table = require("@env/manager")
local Internal: table = require("@env/internal")
local Closures: table = Manager.create()

local Iscclosure: any?, Islclosure: any?, Clonefunction: any?
local ClosureTracking: table = { C = {}, L = {} }

local CallHooks: table = Internal.CallHooks
local Script: table = Internal.Script
local FunctionEnv: table = Internal.FunctionEnv

Closures:define("hookfunction", "replaceclosure", function(Old, New)
  Closures:checktype(1, Old, "function")
  Closures:checktype(2, New, "function")

  CallHooks[Old] = New

  return Clonefunction(Old)
end)

Closures:define("restorefunction", "restoreclosure", function(Old)
  Closures:checktype(1, Old, "function")

  CallHooks[Old] = nil
end)

Clonefunction = Closures:define("clonefunction", function(Function: any): any
  Closures:checktype(1, Function, "function")
  
  local OldEnv: table = getfenv(Function)
  local function New(...)
    return Function(...)
  end
  
  setfenv(New, OldEnv)
  
  FunctionEnv[New] = OldEnv
  
  if Iscclosure(Function) then
    ClosureTracking.C[New] = true
  elseif Islclosure(Function) then
    ClosureTracking.L[New] = true
  end
  
  Script.Functions[New] = Script.Functions[Old]
  
  return New :: any
end)

Iscclosure = Closures:define("iscclosure", function(Function: any): any
  Closures:checktype(1, Function, "function")
  
  if ClosureTracking.C[Function] then
    return true
  end
  
  local Source: string = debug.info(Function, "s")
  local Pattern: string = Process.cwd:gsub("\\", "/") .. "source/environment/"
  
  if Source:sub(1, #Pattern) == Pattern then
    return true
  end
  
  if Source == "[C]" then
    return true
  end
  
  if not Islclosure(Function) then
    return true
  end
  
  return false
end)

Islclosure = Closures:define("islclosure", function(Function: any): any
  Closures:checktype(1, Function, "function")
  
  if ClosureTracking.L[Function] then
    return true
  end
  
  local Source: string = debug.info(Function, "s")
  local Pattern: string = Process.cwd:gsub("\\", "/") .. "source/environment/"
  
  if Source:sub(1, #Pattern) == Pattern then
    return false
  end
  
  if Source ~= '[string "luau.load(...)"]' then
    return false
  end
  
  return true
end)

Closures:define("newcclosure", function(Function: any): any
  Closures:checktype(1, Function, "function")
  
  local New: any = setfenv(function(...)
    return Function(...)
  end, {})
  
  setfenv(New, getfenv(Function))
  
  ClosureTracking.C[New] = true
  
  return New :: any
end)

Closures:define("newlclosure", function(Function: any): any
  Closures:checktype(1, Function, "function")
  
  local New: any = setfenv(function(...)
    return Function(...)
  end, {})
  
  ClosureTracking.L[New] = true
  Script.Functions[New] = Script.Functions[Function]
  
  return New :: any
end)

Internal.Private.Islclosure = Islclosure
Internal.Private.Iscclosure = Iscclosure

return Closures:export() :: table