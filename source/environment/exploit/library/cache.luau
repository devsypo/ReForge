local Internal: table = require("@env/internal")
local Manager: table = require("@env/manager")
local Caches: table = Manager.create()
local InternalObjects: table = {}

local Cache: table = Caches:namespace("cache")

local CachedInstances: table = Internal.CachedInstances

Cache:define("invalidate", function(Object: Instance): nil
  Cache:checktype(1, Object, "Instance")
  
  CachedInstances[Object] = false
  Object.Parent = nil
end)

Cache:define("iscached", function(Object: Instance): boolean
  Cache:checktype(1, Object, "Instance")
  
  return CachedInstances[Object] ~= false
end)

Cache:define("replace", function(Old: Instance, New: Instance)
  Cache:checktype(1, Old, "Instance")
  Cache:checktype(2, New, "Instance")
  
  New.Name = Old.Name
  New.Parent = Old.Parent
  
  CachedInstances[Old] = false
  Old.Parent = nil
end)

Caches:define("cloneref", function(Object: any)
  Cache:checktype(1, Object, "Instance")
  
  local Proxy: userdata = newproxy(true)
  local Properties: table = getmetatable(Proxy)
  
  if not InternalObjects[Object] then
    InternalObjects[Object] = {}
  end
  
  table.insert(InternalObjects[Object], Proxy)
  
  function Properties.__index(_, Key)
    local Value: any = getmetatable(Object)[key]
    
    if type(Value) == "function" then
      return function(_, ...)
        local Args = (...) or nil
        return Value(Object, Args) :: func
      end
    end
    
    return Value :: any
  end
  
  function Properties.__newindex(_, Key, Value)
    Object[Key] = Value
  end
  
  function Properties.__len()
    error("attempt to get a length of a userdata object", 2)
  end
  
  function Properties.__tostring()
    return Object.Name
  end
  
  Properties.__metatable = getmetatable(Object)
  
  return Proxy
end)

Caches:define("compareinstances", function(Left, Right)
  Cache:checktype(1, Left, "userdata", "Instance")
  Cache:checktype(2, Right, "userdata", "Instance")
  
  if not InternalObjects[Left] then
    return Left == Right
  else
    if table.find(InternalObjects[Left], Right) then 
      return true 
    end
  end

 return false
end)

return Caches:export() :: table