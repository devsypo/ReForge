local FS: table = require("@lune/fs")
local Roblox: table = require("@lune/roblox")
local Text: table = require("@dependency/text")
local Manager: table = require("@env/manager")
local FileSystem: table = Manager.create()

local Workspace: string = "../workspace/"
local UseTable: boolean = false

local function SanitizePath(Path: string, Name: string, CheckExtension: boolean): string
  local SanitizedPath: string? = Text.SanitizePath(Path, CheckExtension or true)
  assert(SanitizedPath, "invalid argument #1 to '" .. Name .. "' (unsafe file path)")
  return SanitizedPath :: string
end

local AssetIds: { [string]: string } = {}

FileSystem:define("writefile", function(Path: string, Content: string): nil
  FileSystem:checktype(1, Path, "string")
  FileSystem:checktype(2, Content, "string")
  
  local SanitizedPath: string = SanitizePath(Path, FileSystem:getfunc())
  local FullPath: string = Workspace .. SanitizedPath

  local Status: boolean = pcall(FS.readDir, FullPath)
  assert(not Status, "invalid argument #1 to 'writefile' (expected file got folder)")

  if UseTable then
    return
  end
  
  local WriteStatus: boolean = pcall(FS.writeFile, FullPath, Content)
  assert(WriteStatus, "internal: failed to write a file to path: " .. SanitizedPath)
end)

FileSystem:define("makefolder", function(Path: string): nil
  FileSystem:checktype(1, Path, "string")

  local SanitizedPath: string = SanitizePath(Path, FileSystem:getfunc())
  local FullPath: string = Workspace .. SanitizedPath

  if UseTable then
    return
  end

  local Status: boolean = pcall(FS.writeDir, FullPath)
  assert(Status, "internal: failed to write a folder to path: " .. SanitizedPath)
end)

FileSystem:define("delfile", function(Path: string): nil
  FileSystem:checktype(1, Path, "string")

  local SanitizedPath: string = SanitizePath(Path, FileSystem:getfunc())
  local FullPath: string = Workspace .. SanitizedPath

  local Status: boolean = pcall(FS.readDir, FullPath)
  assert(not Status, "invalid argument #1 to 'delfile' (expected file got folder)")
  
  if UseTable then
    return
  end

  local RemoveStatus: boolean = pcall(FS.removeFile, FullPath)
  assert(RemoveStatus, "internal: failed to delete a file at path: " .. SanitizedPath)
end)

FileSystem:define("delfolder", function(Path: string): nil
  FileSystem:checktype(1, Path, "string")

  local SanitizedPath: string = SanitizePath(Path, FileSystem:getfunc())
  local FullPath: string = Workspace .. SanitizedPath

  local Status, IsDir = pcall(FS.isDir, FullPath)
  assert(Status, "internal: failed to check folder at path: " .. SanitizedPath)
  assert(IsDir, "invalid argument #1 to 'delfolder' (expected folder got file)")

  if UseTable then
    return
  end

  local RemoveStatus: boolean = pcall(FS.removeDir, FullPath)
  assert(RemoveStatus, "internal: failed to delete a folder at path: " .. SanitizedPath)
end)

FileSystem:define("isfile", function(Path: string): boolean
  FileSystem:checktype(1, Path, "string")

  local SanitizedPath: string = SanitizePath(Path, FileSystem:getfunc(), false)
  local FullPath: string = Workspace .. SanitizedPath

  if UseTable then
    return false
  end

  local Status: boolean, isFile: boolean = pcall(FS.isFile, FullPath)
  assert(Status, "internal: failed to check file at path: " .. SanitizedPath)

  return isFile :: boolean
end)

FileSystem:define("isfolder", function(Path: string): boolean
  FileSystem:checktype(1, Path, "string")

  local SanitizedPath: string = SanitizePath(Path, FileSystem:getfunc())
  local FullPath: string = Workspace .. SanitizedPath

  if UseTable then
    return false
  end

  local Status: boolean, isFolder: boolean = pcall(FS.isDir, FullPath)
  assert(Status, "internal: failed to check a folder at path: " .. SanitizedPath)

  return isFolder :: boolean
end)

FileSystem:define("readfile", function(Path: string): string
  FileSystem:checktype(1, Path, "string")

  local SanitizedPath: string = SanitizePath(Path, FileSystem:getfunc())
  local FullPath: string = Workspace .. SanitizedPath

  local Status, IsFile = pcall(FS.isFile, FullPath)
  assert(Status, "internal: failed to check file at path: " .. SanitizedPath)
  assert(IsFile, "invalid argument #1 to 'readfile' (expected file got folder)")

  if UseTable then
    return ""
  end

  local Status2: boolean, Content: string = pcall(FS.readFile, FullPath)
  assert(Status2, "internal: failed to read a file at path: " .. SanitizedPath)

  return Content :: string
end)

FileSystem:define("loadfile", function(Path: string): ()
  FileSystem:checktype(1, Path, "string")

  local SanitizedPath: string = SanitizePath(Path, FileSystem:getfunc())
  local FullPath: string = Workspace .. SanitizedPath

  local Status, IsFile = pcall(FS.isFile, FullPath)
  assert(Status, "internal: failed to check file at path: " .. SanitizedPath)
  assert(IsFile, "invalid argument #1 to 'loadfile' (expected file got folder)")

  error("Disabled")
end)

FileSystem:define("listfiles", function(Path: string): { string }
  FileSystem:checktype(1, Path, "string")

  local SanitizedPath: string = SanitizePath(Path, FileSystem:getfunc())
  local FullPath: string = Workspace .. SanitizedPath
  
  if UseTable then
    return 
  end

  local Status, IsDir = pcall(FS.isDir, FullPath)
  assert(Status, "internal: failed to check folder at path: " .. SanitizedPath)
  assert(IsDir, "invalid argument #1 to 'listfiles' (expected folder got file)")
  
  local Status: boolean, Files: { string } = pcall(FS.readDir, FullPath)
  assert(Status, "internal: failed to check/retrieve files at path: " .. SanitizedPath)
  
  local Out = table.create(#Files)
  
  for i, Value in ipairs(Files) do
    if SanitizedPath == "" then
      Out[i] = Value
      continue
    end
    
    Out[i] = SanitizedPath .. "/" .. Value
  end
  
  return Out
end)

FileSystem:define("appendfile", function(Path: string, Content: string): nil
  FileSystem:checktype(1, Path, "string")
  FileSystem:checktype(2, Content, "string")

  local SanitizedPath: string = SanitizePath(Path, FileSystem:getfunc())
  local FullPath: string = Workspace .. SanitizedPath

  local Status: boolean = pcall(FS.readDir, FullPath)
  assert(not Status, "invalid argument #1 to 'appendfile' (expected file got folder)")

  if UseTable then
    return
  end

  local Existing: string = ""
  local ReadStatus, Data = pcall(FS.readFile, FullPath)
  
  if ReadStatus then
    Existing = Data
  end

  local WriteStatus: boolean = pcall(FS.writeFile, FullPath, Existing .. Content)
  assert(WriteStatus, "internal: failed to append to file at path: " .. SanitizedPath)
end)

FileSystem:define("getcustomasset", "getsynasset", function(Path: string): string
  FileSystem:checktype(1, Path, "string")

  local SanitizedPath: string = SanitizePath(Path, FileSystem:getfunc())
  local FullPath: string = Workspace .. SanitizedPath
  
  local Status: boolean, isFile: boolean = pcall(FS.isFile, FullPath)
  assert(Status, "internal: failed to check file at path: " .. SanitizedPath)
  
  local Cached: string = AssetIds[Path] or "rbxasset://" .. tostring(math.random(100_000_00, 999_999_999))
  AssetIds[Path] = Cached
  
  return Cached :: string
end)

return FileSystem:export() :: table